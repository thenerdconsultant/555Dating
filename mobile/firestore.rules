rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function userDoc(uid) {
      return get(/databases/{database}/documents/users/{uid});
    }

    function requestorGender() {
      return userDoc(request.auth.uid).data.gender;
    }

    function isOppositeGender(targetGender) {
      return requestorGender() != targetGender;
    }

    function isSelfieVerified(doc) {
      return doc.data.moderation.verifiedSelfie == true;
    }

    function isActive(doc) {
      return doc.data.isActive == true;
    }

    match /users/{userId} {
      allow get, list: if request.auth != null
        && isOppositeGender(resource.data.gender)
        && isActive(resource)
        && (resource.data.gender == 'male' || isSelfieVerified(resource));

      allow update, delete: if false;
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    match /matches/{matchId} {
      allow get, list: if request.auth != null
        && resource.data.userIds.hasAny([request.auth.uid]);

      allow create: if request.auth != null
        && request.resource.data.userIds is list
        && request.auth.uid in request.resource.data.userIds;

      allow update, delete: if false;

      match /messages/{messageId} {
        allow get, list: if request.auth != null
          && get(/databases/{database}/documents/matches/{matchId}).data.userIds.hasAny([request.auth.uid]);

        allow create: if request.auth != null
          && request.resource.data.senderId == request.auth.uid
          && get(/databases/{database}/documents/matches/{matchId}).data.userIds.hasAll([request.resource.data.senderId, request.resource.data.recipientId])
          && allowSenderToMessage(request.resource.data.recipientId);

        allow update, delete: if false;
      }
    }

    function allowSenderToMessage(recipientId) {
      let sender = userDoc(request.auth.uid).data;
      let recipient = userDoc(recipientId).data;

      return sender.gender != recipient.gender
        && sender.isActive == true
        && recipient.isActive == true
        && (recipient.gender == 'male' || recipient.moderation.verifiedSelfie == true)
        && (sender.gender != 'male' || sender.subscription.status == 'active');
    }
  }
}
